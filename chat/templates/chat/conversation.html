{% extends 'base.html' %}

{% block title %}{{ conversation.title|default:"새 대화" }} - LLM 채팅{% endblock %}

{% block extra_head %}
<script>
    let socket = null;
    let isSocketConnected = false;

    function connectWebSocket() {
        const conversationId = "{{ conversation.id }}";
        socket = new WebSocket(`ws://${window.location.host}/ws/chat/${conversationId}/`);

        socket.onopen = function(e) {
            console.log("WebSocket connected");
            isSocketConnected = true;
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            appendAssistantMessage(data.message, data.message_id);
            enableMessageInput();
        };

        socket.onclose = function(e) {
            console.log("WebSocket disconnected", e.reason);
            isSocketConnected = false;
            setTimeout(connectWebSocket, 2000);
        };

        socket.onerror = function(err) {
            console.error("WebSocket error", err);
            socket.close();
        };
    }

    function sendMessage(message) {
        if (isSocketConnected) {
            socket.send(JSON.stringify({
                'message': message
            }));
            return true;
        } else {
            return false;
        }
    }

    function appendAssistantMessage(message, messageId) {
        const messagesContainer = document.getElementById('messages-container');
        const messageElement = document.createElement('div');
        messageElement.className = 'assistant-message';
        messageElement.id = `message-${messageId}`;

        const contentElement = document.createElement('div');
        contentElement.className = 'markdown-content';
        contentElement.textContent = message;
        messageElement.appendChild(contentElement);

        messagesContainer.appendChild(messageElement);
        
        // Markdown 렌더링
        contentElement.innerHTML = marked.parse(message);
        
        // 스크롤 맨 아래로
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function disableMessageInput() {
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        messageInput.disabled = true;
        sendButton.disabled = true;
    }

    function enableMessageInput() {
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    }

    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();

        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;

            disableMessageInput();
            
            // 사용자 메시지 UI에 추가 (WebSocket 응답 기다리지 않고)
            const messagesContainer = document.getElementById('messages-container');
            const userMessageElement = document.createElement('div');
            userMessageElement.className = 'user-message';
            userMessageElement.textContent = message;
            messagesContainer.appendChild(userMessageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 메시지 입력창 비우기
            messageInput.value = '';
            
            // WebSocket으로 전송
            const sent = sendMessage(message);
            
            // WebSocket 실패 시 HTMX로 폴백
            if (!sent) {
                console.log("Using HTMX fallback");
                const formData = new FormData();
                formData.append('message', message);
                
                htmx.ajax('POST', `{% url 'chat:send_message' conversation_id=conversation.id %}`, {
                    values: { message: message },
                    target: '#messages-container',
                    swap: 'innerHTML'
                });
            }
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="flex h-full">
    <div class="bg-white rounded-lg shadow-md w-full chat-container">
        <div class="flex justify-between items-center border-b p-4">
            <h1 class="text-xl font-bold" id="conversation-title">
                {{ conversation.title|default:"새 대화" }}
            </h1>
            <button
                class="text-blue-600 hover:text-blue-800"
                onclick="document.getElementById('title-edit').classList.toggle('hidden');
                         document.getElementById('title-display').classList.toggle('hidden');
                         document.getElementById('new-title').focus();">
                수정
            </button>
        </div>
        
        <div id="title-display" class="hidden border-b p-4">
            <form hx-put="{% url 'chat:update_title' conversation_id=conversation.id %}"
                  hx-trigger="submit"
                  hx-target="#conversation-title"
                  hx-swap="innerHTML">
                <div class="flex">
                    <input type="text" id="new-title" name="title" value="{{ conversation.title|default:'' }}"
                           class="flex-grow border rounded-l px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r">저장</button>
                </div>
            </form>
        </div>
        
        <div class="message-list p-4 flex flex-col" id="messages-container">
            {% for message in messages %}
            <div class="{% if message.role == 'user' %}user-message{% else %}assistant-message{% endif %}" id="message-{{ message.id }}">
                {% if message.role == 'user' %}
                    {{ message.content }}
                {% else %}
                    <div class="markdown-content">{{ message.content }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <div class="border-t p-4">
            <form id="message-form" class="flex">
                <input type="text" id="message-input" 
                       class="flex-grow border rounded-l px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="메시지를 입력하세요...">
                <button type="submit" id="send-button"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r">
                    전송
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}